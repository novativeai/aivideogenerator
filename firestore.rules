rules_version = '2';

/**
 * Firestore Security Rules for AI Video Generator
 *
 * CRITICAL SECURITY MEASURES:
 * 1. Clients cannot directly modify the `credits` field - only server can
 * 2. Clients cannot modify the `isAdmin` field - prevents privilege escalation
 * 3. Generation transactions are server-only for audit integrity
 * 4. Failed refunds collection is server-only for security
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Allow users to read their own document
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow users to create their own document (on signup)
      allow create: if request.auth != null
        && request.auth.uid == userId
        && !request.resource.data.keys().hasAny(['isAdmin'])
        && (!request.resource.data.keys().hasAny(['credits']) || request.resource.data.credits == 10);

      // Allow users to update their own document with restrictions
      allow update: if request.auth != null
        && request.auth.uid == userId
        // CRITICAL: Prevent clients from modifying credits directly
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits']))
        // CRITICAL: Prevent clients from modifying isAdmin
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin']))
        // CRITICAL: Prevent clients from modifying sellerProfile.pendingBalance, sellerProfile.withdrawnBalance
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['sellerProfile.pendingBalance', 'sellerProfile.withdrawnBalance']));

      // Users cannot delete their own documents (only admin/server can)
      allow delete: if false;

      // ============================================
      // PAYMENTS SUBCOLLECTION
      // ============================================
      match /payments/{paymentId} {
        // Users can read their own payments
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete payments
        allow create, update, delete: if false;
      }

      // ============================================
      // SUBSCRIPTIONS SUBCOLLECTION
      // ============================================
      match /subscriptions/{subscriptionId} {
        // Users can read their own subscriptions
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete subscriptions
        allow create, update, delete: if false;
      }

      // ============================================
      // PAYOUT REQUESTS SUBCOLLECTION (for sellers)
      // ============================================
      match /payout_requests/{requestId} {
        // Users can read their own payout requests
        allow read: if request.auth != null && request.auth.uid == userId;

        // Users can create payout requests (with restrictions)
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.status == 'pending'
          && request.resource.data.amount > 0;

        // Only server can update/delete payout requests
        allow update, delete: if false;
      }

      // ============================================
      // SELLER PROFILE SUBCOLLECTION
      // ============================================
      match /seller_profile/{profileId} {
        // Users can read their own seller profile
        allow read: if request.auth != null && request.auth.uid == userId;

        // Users can create/update their own seller profile
        allow create, update: if request.auth != null && request.auth.uid == userId;

        // Only server can delete
        allow delete: if false;
      }

      // ============================================
      // SELLER TRANSACTIONS SUBCOLLECTION
      // ============================================
      match /seller_transactions/{transactionId} {
        // Users can read their own seller transactions
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete
        allow create, update, delete: if false;
      }

      // ============================================
      // STUDENT VERIFICATION SUBCOLLECTION
      // ============================================
      match /studentVerification/{docId} {
        // Users can read their own student verification
        allow read: if request.auth != null && request.auth.uid == userId;

        // Users can create their own student verification (pending admin approval)
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.verificationStatus == 'pending';

        // Only server can update/delete (admin approval flow)
        allow update, delete: if false;
      }

      // ============================================
      // PURCHASED VIDEOS SUBCOLLECTION
      // ============================================
      match /purchased_videos/{videoId} {
        // Users can read their own purchased videos
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete purchased videos
        allow create, update, delete: if false;
      }

      // ============================================
      // MARKETPLACE ITEMS SUBCOLLECTION (seller's items)
      // ============================================
      match /marketplace_items/{itemId} {
        // Users can read their own marketplace items
        allow read: if request.auth != null && request.auth.uid == userId;

        // Users can create/update their own marketplace items
        allow create, update: if request.auth != null && request.auth.uid == userId;

        // Only server can delete marketplace items
        allow delete: if false;
      }

      // ============================================
      // GENERATIONS SUBCOLLECTION (user's generation history)
      // ============================================
      match /generations/{generationId} {
        // Users can read their own generations
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete generations
        allow create, update, delete: if false;
      }

      // ============================================
      // SELLER BALANCE SUBCOLLECTION
      // ============================================
      match /seller_balance/{balanceId} {
        // Users can read their own seller balance
        allow read: if request.auth != null && request.auth.uid == userId;

        // Only server can create/update/delete balance records
        allow create, update, delete: if false;
      }
    }

    // ============================================
    // CONTACTS COLLECTION (contact form submissions)
    // ============================================
    match /contacts/{contactId} {
      // Only admins can read contact submissions
      allow read: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // Anyone (authenticated or not) can create contact submissions
      allow create: if true;

      // Only server can update/delete
      allow update, delete: if false;
    }

    // ============================================
    // GENERATION TRANSACTIONS COLLECTION
    // CRITICAL: Server-only for audit trail integrity
    // ============================================
    match /generation_transactions/{transactionId} {
      // Admins can read for audit purposes
      allow read: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // Users can read their own transactions
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // CRITICAL: Only server can create/update/delete transactions
      allow create, update, delete: if false;
    }

    // ============================================
    // FAILED CREDIT REFUNDS COLLECTION
    // CRITICAL: Server-only for security and integrity
    // ============================================
    match /failed_credit_refunds/{refundId} {
      // Only admins can read failed refunds
      allow read: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // CRITICAL: Only server can create/update/delete
      allow create, update, delete: if false;
    }

    // ============================================
    // PROCESSED WEBHOOKS COLLECTION
    // For idempotency checking - server only
    // ============================================
    match /processed_webhooks/{webhookId} {
      // Only admins can read for debugging
      allow read: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // Only server can create/update/delete
      allow create, update, delete: if false;
    }

    // ============================================
    // MARKETPLACE VIDEOS COLLECTION
    // ============================================
    match /marketplaceVideos/{videoId} {
      // Anyone can read marketplace videos (public)
      allow read: if true;

      // Only admins or the video owner can update
      allow update: if request.auth != null
        && (resource.data.sellerId == request.auth.uid
            || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true));

      // Users can create their own marketplace videos (sellerId must match their uid)
      allow create: if request.auth != null
        && request.resource.data.sellerId == request.auth.uid;

      // Only admin can delete
      allow delete: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ============================================
    // MARKETPLACE LISTINGS COLLECTION
    // ============================================
    match /marketplace_listings/{listingId} {
      // Anyone can read published marketplace listings (public)
      allow read: if true;

      // Only admins or the listing owner can update
      allow update: if request.auth != null
        && (resource.data.sellerId == request.auth.uid
            || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true));

      // Users can create their own marketplace listings (sellerId must match their uid)
      allow create: if request.auth != null
        && request.resource.data.sellerId == request.auth.uid;

      // Only admin can delete
      allow delete: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ============================================
    // MARKETPLACE COLLECTION (products)
    // ============================================
    match /marketplace/{productId} {
      // Anyone can read marketplace products (public)
      allow read: if true;

      // Only admins or the product owner can update
      allow update: if request.auth != null
        && (resource.data.sellerId == request.auth.uid
            || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true));

      // Users can create their own marketplace products (sellerId must match their uid)
      allow create: if request.auth != null
        && request.resource.data.sellerId == request.auth.uid;

      // Only admin can delete
      allow delete: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ============================================
    // MARKETPLACE PURCHASES COLLECTION
    // ============================================
    match /marketplace_purchases/{purchaseId} {
      // Buyers can read their own purchases
      allow read: if request.auth != null
        && resource.data.buyerId == request.auth.uid;

      // Sellers can read purchases of their products
      allow read: if request.auth != null
        && resource.data.sellerId == request.auth.uid;

      // Admins can read all purchases
      allow read: if request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // Only server can create/update/delete (via webhook)
      allow create, update, delete: if false;
    }

    // ============================================
    // DEFAULT: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
